<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DMARC Analyzer Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
      line-height: 1.6;
      color: #333;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      text-align: center;
      color: white;
      margin-bottom: 30px;
    }

    .header h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .header p {
      font-size: 1.2rem;
      opacity: 0.9;
    }

    .dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .card {
      background: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
    }

    .card h3 {
      color: #4a5568;
      margin-bottom: 15px;
      font-size: 1.3rem;
      border-bottom: 2px solid #e2e8f0;
      padding-bottom: 10px;
    }

    .stat {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid #f7fafc;
    }

    .stat:last-child {
      border-bottom: none;
    }

    .stat-label {
      font-weight: 500;
      color: #4a5568;
    }

    .stat-value {
      font-weight: bold;
      color: #2d3748;
      font-size: 1.1rem;
    }

    .chart-container {
      position: relative;
      height: 300px;
      margin-top: 15px;
    }

    .api-section {
      background: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      margin-top: 20px;
    }

    .api-section h3 {
      color: #4a5568;
      margin-bottom: 20px;
      font-size: 1.3rem;
    }

    .api-endpoints {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
    }

    .endpoint {
      background: #f7fafc;
      border-left: 4px solid #667eea;
      padding: 15px;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    .endpoint:hover {
      background: #edf2f7;
    }

    .endpoint-method {
      font-weight: bold;
      color: #667eea;
      font-size: 0.9rem;
    }

    .endpoint-path {
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      color: #4a5568;
      margin: 5px 0;
    }

    .endpoint-desc {
      font-size: 0.9rem;
      color: #718096;
    }

    .loading {
      text-align: center;
      color: #718096;
      padding: 20px;
    }

    .error {
      color: #e53e3e;
      background: #fed7d7;
      border: 1px solid #feb2b2;
      border-radius: 8px;
      padding: 15px;
      margin: 10px 0;
    }

    .success {
      color: #38a169;
      background: #c6f6d5;
      border: 1px solid #9ae6b4;
      border-radius: 8px;
      padding: 15px;
      margin: 10px 0;
    }

    .refresh-btn {
      background: #667eea;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      transition: background-color 0.3s ease;
      margin: 10px 5px;
    }

    .refresh-btn:hover {
      background: #5a67d8;
    }

    @media (max-width: 768px) {
      .header h1 {
        font-size: 2rem;
      }

      .dashboard {
        grid-template-columns: 1fr;
      }

      .api-endpoints {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>üõ°Ô∏è DMARC Analyzer</h1>
      <p>Real-time DMARC Report Analysis Dashboard</p>
    </div>

    <div class="dashboard">
      <div class="card">
        <h3>üìä System Status</h3>
        <div id="system-status" class="loading">Loading system status...</div>
      </div>

      <div class="card">
        <h3>üìà Statistics</h3>
        <div id="stats" class="loading">Loading statistics...</div>
      </div>

      <div class="card">
        <h3>üè¢ Top Organizations</h3>
        <div class="chart-container">
          <canvas id="orgsChart"></canvas>
        </div>
      </div>

      <div class="card">
        <h3>üìã Recent Reports</h3>
        <div id="recent-reports" class="loading">Loading recent reports...</div>
      </div>
    </div>

    <div class="api-section">
      <h3>üîå API Endpoints</h3>
      <div class="api-endpoints">
        <div class="endpoint" onclick="testEndpoint('/_cluster/health')">
          <div class="endpoint-method">GET</div>
          <div class="endpoint-path">/_cluster/health</div>
          <div class="endpoint-desc">Elasticsearch cluster health</div>
        </div>

        <div class="endpoint" onclick="testEndpoint('/parsedmarc-*/_search?size=0')">
          <div class="endpoint-method">GET</div>
          <div class="endpoint-path">/parsedmarc-*/_search</div>
          <div class="endpoint-desc">Search DMARC reports</div>
        </div>

        <div class="endpoint" onclick="testEndpoint('/parsedmarc-*/_stats')">
          <div class="endpoint-method">GET</div>
          <div class="endpoint-path">/parsedmarc-*/_stats</div>
          <div class="endpoint-desc">Index statistics</div>
        </div>

        <div class="endpoint" onclick="openKibana()">
          <div class="endpoint-method">WEB</div>
          <div class="endpoint-path">http://localhost:5601</div>
          <div class="endpoint-desc">Kibana Dashboard</div>
        </div>
      </div>

      <div style="text-align: center; margin-top: 20px;">
        <button class="refresh-btn" onclick="loadDashboard()">üîÑ Refresh Data</button>
        <button class="refresh-btn" onclick="generateSampleData()">üìù Generate Sample Data</button>
      </div>
    </div>

    <div id="api-response" style="margin-top: 20px;"></div>
  </div>

  <script>
    const API_BASE = 'http://localhost:9200';

    async function makeRequest(endpoint, options = {}) {
      try {
        const response = await fetch(API_BASE + endpoint, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            ...options.headers
          },
          ...options
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        return await response.json();
      } catch (error) {
        console.error('API Error:', error);
        throw error;
      }
    }

    async function loadSystemStatus() {
      try {
        const health = await makeRequest('/_cluster/health');
        const statusDiv = document.getElementById('system-status');

        const statusColor = health.status === 'green' ? '#38a169' :
          health.status === 'yellow' ? '#d69e2e' : '#e53e3e';

        statusDiv.innerHTML = `
                    <div class="stat">
                        <span class="stat-label">Cluster Status</span>
                        <span class="stat-value" style="color: ${statusColor};">${health.status.toUpperCase()}</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Nodes</span>
                        <span class="stat-value">${health.number_of_nodes}</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Active Shards</span>
                        <span class="stat-value">${health.active_primary_shards}</span>
                    </div>
                `;
      } catch (error) {
        document.getElementById('system-status').innerHTML = `
                    <div class="error">Error loading system status: ${error.message}</div>
                `;
      }
    }

    async function loadStats() {
      try {
        const indices = await makeRequest('/_cat/indices/parsedmarc-*?format=json');
        const statsDiv = document.getElementById('stats');

        if (indices.length === 0) {
          statsDiv.innerHTML = `
                        <div class="stat">
                            <span class="stat-label">Total Reports</span>
                            <span class="stat-value">0</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">Indices</span>
                            <span class="stat-value">0</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">Storage</span>
                            <span class="stat-value">0 KB</span>
                        </div>
                    `;
          return;
        }

        const totalDocs = indices.reduce((sum, index) => sum + parseInt(index['docs.count'] || 0), 0);
        const totalSize = indices.reduce((sum, index) => {
          const size = index['store.size'] || '0b';
          return sum + parseFloat(size.replace(/[^\d.]/g, ''));
        }, 0);

        statsDiv.innerHTML = `
                    <div class="stat">
                        <span class="stat-label">Total Reports</span>
                        <span class="stat-value">${totalDocs.toLocaleString()}</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Indices</span>
                        <span class="stat-value">${indices.length}</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Storage</span>
                        <span class="stat-value">${totalSize.toFixed(1)} KB</span>
                    </div>
                `;
      } catch (error) {
        document.getElementById('stats').innerHTML = `
                    <div class="error">Error loading statistics: ${error.message}</div>
                `;
      }
    }

    async function loadTopOrganizations() {
      try {
        const response = await makeRequest('/parsedmarc-*/_search', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            size: 0,
            aggs: {
              top_orgs: {
                terms: {
                  field: 'org_name.keyword',
                  size: 6
                }
              }
            }
          })
        });

        const buckets = response.aggregations?.top_orgs?.buckets || [];

        if (buckets.length === 0) {
          return;
        }

        const ctx = document.getElementById('orgsChart').getContext('2d');
        new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: buckets.map(b => b.key),
            datasets: [{
              data: buckets.map(b => b.doc_count),
              backgroundColor: [
                '#667eea', '#764ba2', '#f093fb', '#f5576c',
                '#4facfe', '#00f2fe', '#43e97b', '#38f9d7'
              ],
              borderWidth: 0
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'bottom',
                labels: {
                  padding: 15,
                  usePointStyle: true
                }
              }
            }
          }
        });
      } catch (error) {
        console.error('Error loading organizations chart:', error);
      }
    }

    async function loadRecentReports() {
      try {
        const response = await makeRequest('/parsedmarc-*/_search', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            size: 5,
            sort: [{ '@timestamp': { order: 'desc' } }],
            _source: ['org_name', 'report_id', '@timestamp', 'policy_published.domain']
          })
        });

        const hits = response.hits?.hits || [];
        const reportsDiv = document.getElementById('recent-reports');

        if (hits.length === 0) {
          reportsDiv.innerHTML = '<div class="stat"><span class="stat-label">No reports found</span></div>';
          return;
        }

        reportsDiv.innerHTML = hits.map(hit => {
          const source = hit._source;
          const date = new Date(source['@timestamp']).toLocaleDateString();
          return `
                        <div class="stat">
                            <div>
                                <div class="stat-label">${source.org_name}</div>
                                <div style="font-size: 0.8rem; color: #718096;">${date}</div>
                            </div>
                            <div class="stat-value" style="font-size: 0.9rem;">
                                ${source.policy_published?.domain || 'N/A'}
                            </div>
                        </div>
                    `;
        }).join('');
      } catch (error) {
        document.getElementById('recent-reports').innerHTML = `
                    <div class="error">Error loading recent reports: ${error.message}</div>
                `;
      }
    }

    async function testEndpoint(endpoint) {
      const responseDiv = document.getElementById('api-response');
      responseDiv.innerHTML = '<div class="loading">Testing endpoint...</div>';

      try {
        const response = await makeRequest(endpoint);
        responseDiv.innerHTML = `
                    <div class="api-section">
                        <h3>‚úÖ API Response: ${endpoint}</h3>
                        <pre style="background: #f7fafc; padding: 15px; border-radius: 8px; overflow-x: auto; font-size: 0.9rem;">${JSON.stringify(response, null, 2)}</pre>
                    </div>
                `;
      } catch (error) {
        responseDiv.innerHTML = `
                    <div class="api-section">
                        <h3>‚ùå API Error: ${endpoint}</h3>
                        <div class="error">${error.message}</div>
                    </div>
                `;
      }
    }

    function openKibana() {
      window.open('http://localhost:5601', '_blank');
    }

    async function generateSampleData() {
      try {
        const response = await fetch('/api/generate-sample-data', {
          method: 'POST'
        });

        if (response.ok) {
          document.getElementById('api-response').innerHTML = `
                        <div class="success">‚úÖ Sample data generated successfully! Refreshing dashboard...</div>
                    `;
          setTimeout(loadDashboard, 2000);
        } else {
          throw new Error('Failed to generate sample data');
        }
      } catch (error) {
        document.getElementById('api-response').innerHTML = `
                    <div class="error">‚ùå Error generating sample data. Please use the terminal command: ./scripts/generate-sample-data.sh</div>
                `;
      }
    }

    async function loadDashboard() {
      await Promise.all([
        loadSystemStatus(),
        loadStats(),
        loadTopOrganizations(),
        loadRecentReports()
      ]);
    }

    // Load dashboard on page load
    document.addEventListener('DOMContentLoaded', loadDashboard);

    // Auto-refresh every 30 seconds
    setInterval(loadDashboard, 30000);
  </script>
</body>

</html>
